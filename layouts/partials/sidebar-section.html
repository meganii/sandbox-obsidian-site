{{- $node := .Node -}}
{{- $currentPath := .CurrentPath -}}
{{- $level := .Level | default 0 -}}
{{- $nodePath := (urls.Parse $node.RelPermalink).Path -}}
{{- $isActive := eq $nodePath $currentPath -}}
{{- if $node.IsSection -}}
  {{- $childSections := where $node.Pages "IsSection" true -}}
  {{- $childPages := where $node.RegularPages ".Draft" "ne" true -}}
  {{- $isOpen := or $isActive (strings.HasPrefix $currentPath $nodePath) -}}
  {{- $childCount := add (len $childSections) (len $childPages) -}}
  <li>
    <details class="group rounded-lg border border-neutral-200 bg-neutral-50" {{ if $isOpen }}open{{ end }}>
      <summary class="flex cursor-pointer items-center justify-between gap-2 px-3 py-2 text-neutral-800 hover:text-neutral-600">
        <a href="{{ $node.RelPermalink }}" class="flex-1 truncate text-left text-neutral-800 hover:text-neutral-600">{{ $node.LinkTitle | default $node.Title }}</a>
        {{ if gt $childCount 0 }}
          <span class="text-xs text-neutral-400">{{ $childCount }}</span>
        {{ end }}
      </summary>
      {{ if gt $childCount 0 }}
        <ul class="space-y-1 border-t border-neutral-200 py-2 pl-4">
          {{ range $childSections.ByWeight }}
            {{ partial "sidebar-section.html" (dict "Node" . "CurrentPath" $currentPath "Level" (add $level 1)) }}
          {{ end }}
          {{ range $childPages.ByWeight }}
            {{ partial "sidebar-section.html" (dict "Node" . "CurrentPath" $currentPath "Level" (add $level 1)) }}
          {{ end }}
        </ul>
      {{ end }}
    </details>
  </li>
{{- else -}}
  <li>
    <a href="{{ $node.RelPermalink }}" class="block rounded-md px-2 py-1.5 text-neutral-600 hover:bg-neutral-100 hover:text-neutral-900 {{ if $isActive }}bg-neutral-100 text-neutral-900 font-semibold{{ end }}">{{ $node.LinkTitle | default $node.Title }}</a>
  </li>
{{- end -}}
